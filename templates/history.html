{% extends "base.html" %}

{% block title %}Analysis History{% endblock %}

{% block content %}
<div class="card">
    <h1>Your Analysis History</h1>
    <p>View all your previous diabetic retinopathy analyses.</p>
</div>

{% if analyses and analyses|length > 0 %}
    {% for analysis in analyses %}
    <div class="card history-item">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; flex-wrap: wrap; gap: 20px;">
            <div>
                <h3 style="margin-bottom: 8px; border-bottom: none; padding-bottom: 0;">
                    Patient: {{ analysis.patient_name or 'N/A' }}
                </h3>
                <p style="color: #6a6a6a; font-size: 14px; margin: 0;">
                    <strong>Age:</strong> {{ analysis.patient_age or 'N/A' }} | 
                    <strong>Date:</strong> {{ analysis.analysis_datetime.strftime('%B %d, %Y at %I:%M %p') if analysis.analysis_datetime else 'N/A' }}
                </p>
            </div>
            <div style="text-align: right;">
                {% if analysis.ensemble_prediction is not none %}
                    <div style="display: inline-block; padding: 8px 16px; background-color: 
                        {% if analysis.ensemble_prediction == 0 %}#e8f5e9{% elif analysis.ensemble_prediction == 1 %}#fff3e0{% elif analysis.ensemble_prediction == 2 %}#ffe0b2{% elif analysis.ensemble_prediction == 3 %}#ffccbc{% else %}#ffebee{% endif %}; 
                        color: 
                        {% if analysis.ensemble_prediction == 0 %}#2e7d32{% elif analysis.ensemble_prediction == 1 %}#e65100{% elif analysis.ensemble_prediction == 2 %}#ef6c00{% elif analysis.ensemble_prediction == 3 %}#d84315{% else %}#c62828{% endif %}; 
                        border-radius: 6px; font-weight: 600; font-size: 14px;">
                        Stage {{ analysis.ensemble_prediction }}
                    </div>
                    <p style="font-size: 13px; color: #6a6a6a; margin-top: 8px;">
                        Confidence: {{ "%.1f" | format(analysis.ensemble_confidence * 100) if analysis.ensemble_confidence else 'N/A' }}%
                    </p>
                {% else %}
                    <div style="display: inline-block; padding: 8px 16px; background-color: #f5f5f5; color: #6a6a6a; border-radius: 6px; font-weight: 600; font-size: 14px;">
                        N/A
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="column-container" style="margin-top: 20px;">
            <!-- Image Preview -->
            <div class="column-item">
                <h4 style="font-family: 'Rubik', sans-serif; font-size: 16px; font-weight: 600; color: #2a2a2a; margin-bottom: 12px;">Original Image</h4>
                {% if analysis.original_image_path %}
                    <img src="{{ url_for('static', filename='uploaded_images/' + analysis.original_image_path) }}" 
                         alt="Fundus Image" 
                         style="max-width: 100%; height: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
                {% else %}
                    <p style="color: #6a6a6a; font-size: 14px;">Image not available</p>
                {% endif %}
            </div>

            <!-- Analysis Summary -->
            <div class="column-item">
                <h4 style="font-family: 'Rubik', sans-serif; font-size: 16px; font-weight: 600; color: #2a2a2a; margin-bottom: 12px;">Analysis Summary</h4>
                
                {% if analysis.individual_results %}
                    <div style="background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #2a2a2a; margin-bottom: 10px;">Model Results</h5>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            {% for model_name, result in analysis.individual_results.items() %}
                                <li style="margin-bottom: 8px; font-size: 14px; color: #4a4a4a;">
                                    <strong>{{ model_name }}:</strong> 
                                    {% if result.predicted_class is not none %}
                                        Stage {{ result.predicted_class }} ({{ "%.2f" | format(result.confidence * 100) }}%)
                                    {% else %}
                                        Error
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if analysis.synthetic_report %}
                    <div style="background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #2a2a2a; margin-bottom: 10px;">Synthetic Report</h5>
                        <div style="font-size: 14px; color: #4a4a4a; line-height: 1.6; max-height: 150px; overflow-y: auto;">
                            {{ analysis.synthetic_report[:300] }}{% if analysis.synthetic_report|length > 300 %}...{% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Grad-CAM Images -->
        {% if analysis.gradcam_paths and analysis.gradcam_paths|length > 0 %}
        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
            <h4 style="font-family: 'Rubik', sans-serif; font-size: 16px; font-weight: 600; color: #2a2a2a; margin-bottom: 16px;">Grad-CAM Visualizations</h4>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                {% for gradcam_path in analysis.gradcam_paths %}
                    <div style="text-align: center;">
                        <img src="{{ url_for('static', filename='uploaded_images/' + gradcam_path) }}" 
                             alt="Grad-CAM" 
                             style="max-width: 200px; height: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}

{% else %}
    <div class="card" style="text-align: center; padding: 60px 40px;">
        <h3 style="color: #6a6a6a; font-weight: 500; margin-bottom: 16px; border-bottom: none;">No Analysis History</h3>
        <p style="color: #8a8a8a; font-size: 15px; margin-bottom: 24px;">You haven't performed any analyses yet.</p>
        <a href="{{ url_for('index') }}" style="display: inline-block; padding: 14px 28px; background-color: #1a1a1a; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-family: 'Rubik', sans-serif; transition: all 0.3s ease;">
            Start Your First Analysis
        </a>
    </div>
{% endif %}

<style>
    .history-item {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .history-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
    }

    @media (max-width: 768px) {
        .history-item > div:first-child {
            flex-direction: column;
        }
        
        .history-item > div:first-child > div:last-child {
            text-align: left;
            margin-top: 10px;
        }
    }
</style>
{% endblock %}